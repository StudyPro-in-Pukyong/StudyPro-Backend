<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8">
        <title>Alert List</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css">
        <style>
            .header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 10px;
                background-color: #4da6ff;
                color: white;
                font-size: 20px;
                position: relative; /* ì œëª©ê³¼ ì“°ë ˆê¸°í†µ ë°°ì¹˜ */
            }
            .header-title {
                position: absolute;
                left: 50%;
                transform: translateX(-50%);
            }
            .header-icons {
                display: flex;
                align-items: center;
                cursor: pointer;
            }
            .header-icons img {
                width: 25px;
                height: 25px;
                margin-left: 10px;
            }
            .notification-container {
                background-color: #f7f7f7;
                font-family: Arial, sans-serif;
                padding: 20px;
            }

            .notification {
                width: 100%;
                background: #fff;
                padding: 15px;
                border-radius: 12px;
                margin-bottom: 15px;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                display: flex;
                align-items: flex-start;
                position: relative; /* ë²„íŠ¼ ìœ„ì¹˜ ê¸°ì¤€ ì„¤ì • */
            }

            .notification-icon {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-size: 20px;
                margin-right: 10px;
            }

            .notification-content {
                flex: 1;
            }

            .notification-title {
                font-weight: bold;
                color: #555;
                font-size: 15px;
            }

            .notification-message {
                font-size: 16px;
                margin-top: 4px;
                color: #333;
            }

            .notification-time {
                font-size: 12px;
                color: gray;
                margin-top: 4px;
                text-align: right;
            }

            .accept-button {
                position: absolute;
                right: 15px; /* ë¶€ëª¨ ìš”ì†Œì˜ ì˜¤ë¥¸ìª½ì—ì„œ 15px */
                top: 15px; /* ë¶€ëª¨ ìš”ì†Œì˜ ìœ„ì—ì„œ 15px */
                background-color: #4da6ff;
                color: white;
                border: none;
                border-radius: 5px;
                padding: 5px 10px;
                cursor: pointer;
            }
        </style>
    </head>
    <body>
        <div class="header">
            <div class="header-icons">
                <a th:href="@{/clazz}">
                    <img id="before" src="/images/left.png" alt="before">
                </a>
            </div>
            <div id="title" class="header-title">ì•Œë¦¼</div>
        </div>

        <div class="notification-container" id="notification-container"></div>

        <!-- í† ìŠ¤íŠ¸ ì•Œë¦¼ ì»¨í…Œì´ë„ˆ -->
        <div id="toast-container" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000;"></div>

        <script th:src="@{/js/token.js}"></script>
        <script th:src="@{/js/toast.js}"></script>
    </body>
    <script>
        document.addEventListener('DOMContentLoaded', fetchAlerts);

        // APIë¥¼ í†µí•´ ìš”ì²­ ì•ŒëŒ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
        const alerts = [];
        function fetchAlerts() {
            fetchWithAuth(`/alerts`, {
                method: 'GET'
            }).then(response => {
                if (response.status >= 400) {
                    throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${response.status}`);
                }
                return response.json();
            }).then(data => {
                alerts.push(...data);
                populateAlertTable()
            }).catch(error => console.error('API ìš”ì²­ ì‹¤íŒ¨:', error));
        }

        // ë°ì´í„°ë¥¼ í…Œì´ë¸”ì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
        function populateAlertTable() {
            const container = document.getElementById('notification-container');
            container.innerHTML = '';  // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”

            if (alerts.length === 0) {
                // ì•Œë¦¼ì´ ì—†ëŠ” ê²½ìš°
                container.innerHTML = `<div class="no-alert">ìƒˆ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤</div>`;
                container.querySelector(".no-alert").style.cssText = `
                        text-align: center;
                        font-size: 18px;
                        color: gray;
                        padding: 20px;
                    `;
                return;
            }

            alerts.forEach(alert => {
                const notification = document.createElement('div');
                notification.className = 'notification';

                const classTitle = alert.classTitle;
                const amount = alert.amount;
                const title = `"${classTitle}" ìˆ˜ì—… ì„ ìƒë‹˜ ì›”ê¸‰ ìš”ì²­ ì•Œë¦¼`;
                const requestDate = alert.requestDate;
                const settleDate = alert.settleDate;
                let message;
                if(settleDate != null) message = `${settleDate} ì›”ê¸‰ì„ ìš”ì²­í•©ë‹ˆë‹¤.`;
                else message = `ì›”ê¸‰ì„ ìš”ì²­í•©ë‹ˆë‹¤.`

                notification.innerHTML = `
                        <div class="notification-icon">ğŸ””</div>
                        <div class="notification-content" data-alert-id=${alert.id}>
                            <div class="notification-title">${title}</div>
                            <div class="notification-message">${message}</div>
                            <div class="notification-time">${requestDate}</div>
                        </div>
                    `;

                // `acceptDate`ê°€ ìˆì„ ë•Œ ë‘ ë²ˆì§¸ ì•Œë¦¼ ì¶”ê°€
                const acceptDate = alert.acceptDate;
                if (acceptDate) {
                    const acceptNotification = document.createElement('div');
                    acceptNotification.className = 'notification';

                    const acceptTitle = `"${classTitle}" ìˆ˜ì—… í•™ë¶€ëª¨ë‹˜ ì›”ê¸‰ ìˆ˜ë½ ì•Œë¦¼`;
                    let acceptMessage;
                    if(settleDate != null) acceptMessage = `${settleDate} ì›”ê¸‰ ìš”ì²­ì´ ìˆ˜ë½ë˜ì—ˆìŠµë‹ˆë‹¤. (ìš”ì²­ì¼ : ${requestDate})`;
                    else acceptMessage = `ì›”ê¸‰ ìš”ì²­ì´ ìˆ˜ë½ë˜ì—ˆìŠµë‹ˆë‹¤. (ìš”ì²­ì¼ : ${requestDate})`

                    acceptNotification.innerHTML = `
                        <div class="notification-icon">âœ…</div>
                        <div class="notification-content">
                            <div class="notification-title">${acceptTitle}</div>
                            <div class="notification-message">${acceptMessage}</div>
                            <div class="notification-time">${acceptDate}</div>
                        </div>
                    `;

                    container.appendChild(acceptNotification);
                } else { // `acceptDate`ê°€ ì—†ëŠ” ê²½ìš°
                    const acceptButton = document.createElement('button');
                    acceptButton.textContent = 'ìˆ˜ë½';
                    acceptButton.classList.add('btn', 'btn-primary', 'accept-button');
                    acceptButton.addEventListener('click', () => acceptAlert(alert.id, notification));
                    notification.appendChild(acceptButton);
                }

                container.appendChild(notification);
            });
        }

        // ìˆ˜ë½ ë²„íŠ¼ í´ë¦­ ì‹œ ì„œë²„ì— ìˆ˜ë½ ìš”ì²­ì„ ë³´ë‚´ëŠ” í•¨ìˆ˜
        function acceptAlert(alertId, notification) {
            fetchWithAuth(`/alert/accept?alertId=${alertId}`, {
                method: 'POST'
            }).then(response => {
                if (response.ok) {
                    // ìš”ì²­ì´ ì„±ê³µí•˜ë©´ ë²„íŠ¼ì„ ì œê±°í•˜ê³  ìˆ˜ë½ëœ ì•Œë¦¼ìœ¼ë¡œ ì—…ë°ì´íŠ¸
                    notification.querySelector('.accept-button').remove();
                    alerts.filter(alert => alert.id === alertId)[0].acceptDate = formatDateToYYYYMMDD();
                    populateAlertTable();
                    showToast('ìˆ˜ë½ë˜ì—ˆìŠµë‹ˆë‹¤', 2000, true); // ì„±ê³µ ì•Œë¦¼
                } else {
                    throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${response.status}`);
                }
            }).catch(error => {
                showToast('ì•ŒëŒ ìˆ˜ë½ ìš”ì²­ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 4000, false); // ì‹¤íŒ¨ ì•Œë¦¼
                console.error('ìˆ˜ë½ ìš”ì²­ ì˜¤ë¥˜:', error);
            });
        }

        // ë‚ ì§œë¥¼ "yyyy-mm-dd" í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
        function formatDateToYYYYMMDD() {
            const date = new Date();
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0'); // ì›”ì€ 0ë¶€í„° ì‹œì‘í•˜ë¯€ë¡œ +1
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
    </script>
</html>
